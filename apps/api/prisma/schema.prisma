// datasource & generator are assumed in root schema or here:
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
generator client {
  provider = "prisma-client-js"
}

model ArticleGroupMirror {
  id               String             @id @default(uuid())
  externalId       String             @unique
  name             String
  description      String?
  parentExternalId String?
  sortOrder        Int?

  articles         ArticleMirror[]

  media            GroupMediaLink[]
  categories       GroupCategoryLink[]

  @@index([externalId])
}

model ArticleMirror {
  id            String   @id @default(uuid())
  externalId    String   @unique
  articleGroupId String  // FK -> ArticleGroupMirror.id
  sku           String?
  ean           String?
  title         String
  description   String?
  uom           String?
  updatedAt     DateTime

  attributes    Json?

  articleGroup  ArticleGroupMirror @relation(fields: [articleGroupId], references: [id], onDelete: Cascade)

  media         ArticleMediaLink[]

  @@index([articleGroupId])
}

model MediaAsset {
  id         String   @id @default(uuid())
  key        String
  mime       String
  width      Int?
  height     Int?
  sizeBytes  Int?
  checksum   String?
  variants   Json?

  // reverse: links
  groupLinks   GroupMediaLink[]
  articleLinks ArticleMediaLink[]
}

model GroupMediaLink {
  id       String  @id @default(uuid())
  groupId  String
  mediaId  String
  altText  String?
  sortOrder Int     @default(0)

  group   ArticleGroupMirror @relation(fields: [groupId], references: [id], onDelete: Cascade)
  media   MediaAsset         @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  @@index([groupId])
  @@index([mediaId])
  @@unique([groupId, sortOrder])
}

model ArticleMediaLink {
  id        String  @id @default(uuid())
  articleId String
  mediaId   String
  altText   String?
  sortOrder Int     @default(0)

  article ArticleMirror @relation(fields: [articleId], references: [id], onDelete: Cascade)
  media   MediaAsset    @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  @@index([articleId])
  @@index([mediaId])
  @@unique([articleId, sortOrder])
}
model Category {
  id     String  @id @default(uuid())
  name   String  @unique
  color  String

  groups GroupCategoryLink[]
}

model GroupCategoryLink {
  id         String  @id @default(uuid())
  groupId    String
  categoryId String

  group    ArticleGroupMirror @relation(fields: [groupId], references: [id], onDelete: Cascade)
  category Category           @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([groupId])
  @@index([categoryId])
  @@unique([groupId, categoryId])
}
